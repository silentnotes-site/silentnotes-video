<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SilentNotes Videos</title>

<style>
*{box-sizing:border-box}
body{
margin:0;
font-family:Inter,Arial;
background:linear-gradient(135deg,#ff0080,#7928ca,#2afadf);
background-size:400% 400%;
animation:bg 18s infinite alternate;
color:white;
overflow-x:hidden;
}
@keyframes bg{0%{background-position:0%}100%{background-position:100%}}

h1{text-align:center;margin:20px 0;font-weight:800}
#container{max-width:480px;margin:auto;padding-bottom:80px}

/* BUTTONS */
button{
border:none;
border-radius:14px;
padding:10px 18px;
font-weight:700;
cursor:pointer;
transition:.2s;
}
button:active{transform:scale(.95)}
.btn-send{
background:linear-gradient(135deg,#2afadf,#00c6ff);
color:black;
}
.btn-cancel{
background:rgba(255,255,255,.15);
color:white;
}

/* UPLOAD */
#uploadBtn{
margin:0 auto 10px;
display:block;
background:white;
color:black;
border-radius:22px;
padding:14px 28px;
}

/* FEED */
#feed{
display:flex;
flex-direction:column;
gap:30px;
padding:0 12px;
}

.videoCard{
background:rgba(0,0,0,.25);
border-radius:26px;
overflow:hidden;
backdrop-filter:blur(8px);
}

/* PLAYER */
.player{
position:relative;
width:100%;
height:75vh;
background:black;
overflow:hidden;
}

.player video{
width:100%;
height:100%;
object-fit:cover;
cursor:pointer;
}

/* OVERLAY */
.overlayRight{
position:absolute;
right:10px;
bottom:90px;
display:flex;
flex-direction:column;
gap:14px;
align-items:center;
z-index:5;
}

.action{
background:rgba(0,0,0,.55);
padding:10px;
border-radius:50%;
font-size:14px;
cursor:pointer;
}

/* CONTROLS */
.controls{
position:absolute;
bottom:0;
left:0;
right:0;
padding:10px;
display:flex;
align-items:center;
gap:10px;
background:linear-gradient(transparent,rgba(0,0,0,.75));
}

.play{
width:42px;
height:42px;
border-radius:50%;
background:white;
color:black;
display:flex;
align-items:center;
justify-content:center;
font-weight:900;
cursor:pointer;
}

.progress{
flex:1;
height:6px;
background:rgba(255,255,255,.3);
border-radius:10px;
overflow:hidden;
cursor:pointer;
}
.bar{
height:100%;
width:0%;
background:white;
}

/* META / COMMENTS */
.meta{
padding:14px;
background:rgba(0,0,0,.35);
}

.tags{opacity:.8;font-size:14px}

.comments{
margin-top:10px;
display:flex;
flex-direction:column;
gap:6px;
max-height:200px;
overflow-y:auto;
}

.comment{
background:rgba(255,255,255,.18);
padding:6px 10px;
border-radius:12px;
font-size:14px;
}

.addComment{
display:flex;
gap:6px;
margin-top:8px;
}
.addComment input{
flex:1;
padding:8px 12px;
border-radius:12px;
border:none;
outline:none;
}

/* UPLOAD MODAL */
#uploadModal{
display:none;
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,.7);
z-index:10000;
align-items:center;
justify-content:center;
}
.modalContent{
background:#111;
padding:20px;
border-radius:20px;
width:90%;
max-width:400px;
display:flex;
flex-direction:column;
gap:12px;
}
.modalContent input{
padding:10px;
border-radius:12px;
border:none;
}
.modalBtns{
display:flex;
gap:10px;
justify-content:center;
}

.empty{
text-align:center;
opacity:.7;
margin-top:50px;
font-size:18px;
}
</style>
</head>

<body>

<h1>SilentNotes Videos</h1>

<div id="container">
<button id="uploadBtn">Carica un Video</button>
<div id="feed"><div class="empty">Nessun video disponibile</div></div>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal">
<div class="modalContent">
<h2>Carica Video</h2>
<input type="file" id="fileInputModal" accept="video/*">
<input type="text" id="videoDescriptionModal" placeholder="Descrizione...">
<input type="text" id="videoHashtagsModal" placeholder="#trend #viral">
<div class="modalBtns">
<button id="cancelUpload" class="btn-cancel">Annulla</button>
<button id="confirmUpload" class="btn-send">Invia</button>
</div>
</div>
</div>

<script>
const feed=document.getElementById('feed')
const uploadBtn=document.getElementById('uploadBtn')
const uploadModal=document.getElementById('uploadModal')

uploadBtn.onclick=()=>uploadModal.style.display='flex'
cancelUpload.onclick=()=>uploadModal.style.display='none'

confirmUpload.onclick=async()=>{
const file=fileInputModal.files[0]
if(!file||!file.type.startsWith('video/'))return alert('Seleziona un video valido')
const f=new FormData()
f.append('file',file)
f.append('description',videoDescriptionModal.value)
f.append('hashtags',videoHashtagsModal.value)
await fetch('/api/upload',{method:'POST',body:f})
uploadModal.style.display='none'
loadVideos()
}

async function loadVideos(){
const r=await fetch('/api/videos')
const d=await r.json()
feed.innerHTML=''
if(!d.videos?.length){
feed.innerHTML='<div class="empty">Nessun video disponibile</div>'
return
}

d.videos.forEach(v=>{
const likedKey='liked_'+v.id
const card=document.createElement('div')
card.className='videoCard'
card.innerHTML=`
<div class="player">
<video src="/media/${v.filename}" loop playsinline></video>

<div class="overlayRight">
<div class="action">üëÅ ${v.views||0}</div>
<div class="action" onclick="share('${v.id}')">üîó</div>
<div class="action" id="like-${v.id}" style="color:${localStorage.getItem(likedKey)?'red':'white'}">‚ù§Ô∏è ${v.likes||0}</div>
</div>

<div class="controls">
<div class="play">‚ñ∂</div>
<div class="progress"><div class="bar"></div></div>
</div>
</div>

<div class="meta">
<div>${v.description||''}</div>
<div class="tags">${v.hashtags||''}</div>

<div class="comments" id="com-${v.id}">
${(v.comments||[]).map(c=>`<div class="comment">${c.text}</div>`).join('')}
</div>

<div class="addComment">
<input id="i-${v.id}" placeholder="Commenta in anonimo">
<button class="btn-send" onclick="comment('${v.id}',this)">Invia</button>
</div>
</div>
`
feed.appendChild(card)

const video=card.querySelector('video')
const play=card.querySelector('.play')
const bar=card.querySelector('.bar')
const progress=card.querySelector('.progress')

function toggle(){
document.querySelectorAll('video').forEach(v=>v!==video&&v.pause())
if(video.paused){video.play();play.textContent='‚ùö‚ùö'}else{video.pause();play.textContent='‚ñ∂'}
}
video.onclick=toggle
play.onclick=toggle

video.ontimeupdate=()=>bar.style.width=(video.currentTime/video.duration*100||0)+'%'
progress.onclick=e=>video.currentTime=video.duration*(e.offsetX/progress.clientWidth)

video.onplay=()=>fetch('/api/view/'+v.id,{method:'POST'})

const like=document.getElementById('like-'+v.id)
like.onclick=async()=>{
if(localStorage.getItem(likedKey))return
localStorage.setItem(likedKey,'1')
like.style.color='red'
await fetch('/api/like/'+v.id,{method:'POST'})
like.textContent='‚ù§Ô∏è '+((v.likes||0)+1)
}
})
}

/* COMMENT */
async function comment(id,btn){
const i=document.getElementById('i-'+id)
if(!i.value.trim())return
btn.disabled=true
const r=await fetch('/api/comment/'+id,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({text:i.value})
})
btn.disabled=false
const d=await r.json()
if(d.ok){
document.getElementById('com-'+id).innerHTML+=`<div class="comment">${d.comment.text}</div>`
i.value=''
}
}

/* SHARE */
function share(id){
const url=location.origin+'/?video='+id
navigator.share?navigator.share({url}):(navigator.clipboard.writeText(url),alert('Link copiato'))
}

/* OPEN VIDEO FROM LINK */
const openId=new URLSearchParams(location.search).get('video')
if(openId){
setTimeout(()=>{
const el=document.getElementById('like-'+openId)
if(el) el.closest('.videoCard').scrollIntoView({behavior:'smooth'})
},600)
}

loadVideos()
</script>

</body>
</html>
