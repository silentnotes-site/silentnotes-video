<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SilentNotes Videos</title>
<style>
*{box-sizing:border-box}
body{
margin:0;
font-family:Inter,Arial;
background:linear-gradient(135deg,#ff0080,#7928ca,#2afadf);
background-size:400% 400%;
animation:bg 18s infinite alternate;
color:white;
overflow-x:hidden;
}
@keyframes bg{0%{background-position:0%}100%{background-position:100%}}
h1{text-align:center;margin:20px 0;font-weight:800}
#container{max-width:480px;margin:auto;padding-bottom:80px}
#uploadBtn{
display:flex;
align-items:center;
justify-content:center;
margin:0 auto 10px;
padding:14px 28px;
border:none;
border-radius:22px;
background:white;
color:black;
font-weight:700;
cursor:pointer;
transition:.25s;
box-shadow:0 6px 15px rgba(0,0,0,.25);
}
#uploadBtn:hover{transform:scale(1.05)}
#feed{
display:flex;
flex-direction:column;
gap:30px;
padding:0 12px;
}
.videoCard{
background:rgba(0,0,0,.25);
border-radius:26px;
overflow:hidden;
backdrop-filter:blur(8px);
transition:.3s;
position:relative;
}
.fullscreen-player{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:black;
z-index:9999;
display:flex;
flex-direction:column;
}
.fullscreen-player video{
width:100%;
height:100%;
object-fit:contain;
cursor:pointer;
background:black;
}
.overlayRight{
position:absolute;
right:10px;
bottom:80px;
display:flex;
flex-direction:column;
gap:14px;
font-size:14px;
align-items:center;
z-index:10;
}
.action{
background:rgba(0,0,0,.55);
padding:10px;
border-radius:50%;
cursor:pointer;
display:flex;
align-items:center;
justify-content:center;
transition:.25s;
}
.action:hover{transform:scale(1.2)}
.controls{
position:absolute;
bottom:0;
left:0;
right:0;
padding:10px;
display:flex;
align-items:center;
gap:10px;
background:linear-gradient(transparent,rgba(0,0,0,.75));
z-index:10;
}
.play{
width:42px;
height:42px;
border-radius:50%;
background:white;
color:black;
display:flex;
align-items:center;
justify-content:center;
font-weight:900;
cursor:pointer;
transition:.25s;
}
.play:hover{transform:scale(1.1)}
.progress{
flex:1;
height:6px;
background:rgba(255,255,255,.3);
border-radius:10px;
overflow:hidden;
cursor:pointer;
}
.bar{
height:100%;
width:0%;
background:white;
transition:.1s linear;
}
.meta{
padding:14px;
display:flex;
flex-direction:column;
gap:6px;
}
.tags{opacity:.8;font-size:14px}
.comments{
margin-top:10px;
display:flex;
flex-direction:column;
gap:6px;
max-height:200px;
overflow-y:auto;
position:relative;
z-index:1;
}
.comment{
background:rgba(255,255,255,.18);
padding:6px 10px;
border-radius:12px;
font-size:14px;
}
.addComment{
display:flex;
gap:6px;
margin-top:8px;
position:relative;
z-index:1;
}
.addComment input{
flex:1;
padding:8px 12px;
border-radius:12px;
border:none;
outline:none;
}
.addComment button{
padding:8px 14px;
border:none;
border-radius:12px;
background:white;
color:black;
cursor:pointer;
transition:.25s;
font-weight:700;
}
.addComment button:hover{transform:scale(1.05)}
.empty{
text-align:center;
opacity:.7;
margin-top:50px;
font-size:18px;
}

/* Modale caricamento video */
#uploadModal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,.7);
z-index:10000;
align-items:center;
justify-content:center;
}
#uploadModal .modalContent{
background:#111;
padding:20px;
border-radius:20px;
width:90%;
max-width:400px;
display:flex;
flex-direction:column;
gap:12px;
}
#uploadModal h2{
color:white;
text-align:center;
margin:0;
}
#uploadModal input[type="text"], #uploadModal input[type="file"]{
padding:10px;
border-radius:12px;
border:none;
outline:none;
}
#uploadModal .modalBtns{
display:flex;
gap:10px;
justify-content:center;
}
#uploadModal button{
padding:10px 20px;
border:none;
border-radius:12px;
cursor:pointer;
font-weight:700;
}
#uploadModal #cancelUpload{background:red;color:white;}
#uploadModal #confirmUpload{background:white;color:black;}
</style>
</head>
<body>

<h1>SilentNotes Videos</h1>

<div id="container">
<button id="uploadBtn">Carica un Video</button>
<div id="feed"><div class="empty">Nessun video disponibile</div></div>
</div>

<div id="fullscreenWrapper" style="display:none;"></div>

<!-- Modale caricamento video -->
<div id="uploadModal">
  <div class="modalContent">
    <h2>Carica Video</h2>
    <input type="file" id="fileInputModal" accept="video/*">
    <input type="text" id="videoDescriptionModal" placeholder="Scrivi una descrizione virale...">
    <input type="text" id="videoHashtagsModal" placeholder="#trend #fun #viral">
    <div class="modalBtns">
      <button id="cancelUpload">Annulla</button>
      <button id="confirmUpload">Invia</button>
    </div>
  </div>
</div>

<script>
const feed=document.getElementById('feed')
const uploadBtn=document.getElementById('uploadBtn')
const fullscreenWrapper=document.getElementById('fullscreenWrapper')

const uploadModal=document.getElementById('uploadModal')
const fileInputModal=document.getElementById('fileInputModal')
const videoDescriptionModal=document.getElementById('videoDescriptionModal')
const videoHashtagsModal=document.getElementById('videoHashtagsModal')
const cancelUpload=document.getElementById('cancelUpload')
const confirmUpload=document.getElementById('confirmUpload')

uploadBtn.onclick=()=>uploadModal.style.display='flex'
cancelUpload.onclick=()=>{
    uploadModal.style.display='none'
    fileInputModal.value=''
    videoDescriptionModal.value=''
    videoHashtagsModal.value=''
}

confirmUpload.onclick=async()=>{
    const file=fileInputModal.files[0]
    if(!file){alert('Seleziona un video!'); return}
    if(!file.type.startsWith('video/')){alert('Puoi caricare solo video!'); return}
    const f=new FormData()
    f.append('file', file)
    f.append('description', videoDescriptionModal.value)
    f.append('hashtags', videoHashtagsModal.value)
    await fetch('/api/upload',{method:'POST',body:f})
    uploadModal.style.display='none'
    fileInputModal.value=''
    videoDescriptionModal.value=''
    videoHashtagsModal.value=''
    loadVideos()
}

let startY=0

async function loadVideos(){
const r=await fetch('/api/videos')
const d=await r.json()
feed.innerHTML=''
if(!d.videos||!d.videos.length){
feed.innerHTML='<div class="empty">Nessun video disponibile</div>'
return
}
d.videos.forEach(v=>{
const c=document.createElement('div')
c.className='videoCard'
const likesKey='liked_'+v.id
const liked=localStorage.getItem(likesKey)
c.innerHTML=`
<div class="player">
<video src="/media/${v.filename}" loop playsinline></video>
<div class="overlayRight">
<div class="action">üëÅ ${v.views||0}</div>
<div class="action" onclick="share('${v.id}')">üîó</div>
<div class="action" id="like-${v.id}" style="color:${liked?'red':'white'}">‚ù§Ô∏è ${v.likes||0}</div>
<div class="action" onclick="toggleFullscreen('${v.id}')">‚õ∂</div>
</div>
<div class="controls">
<div class="play">‚ñ∂</div>
<div class="progress"><div class="bar"></div></div>
</div>
</div>
<div class="meta">
<div>${v.description||''}</div>
<div class="tags">${v.hashtags||''}</div>
<div class="comments" id="com-${v.id}">
${v.comments.map(x=>`<div class="comment">${x.text}</div>`).join('')}
</div>
<div class="addComment">
<input id="i-${v.id}" placeholder="Commenta in anonimo">
<button onclick="comment('${v.id}', this)">Invia</button>
</div>
</div>
`
feed.appendChild(c)
const video=c.querySelector('video')
const play=c.querySelector('.play')
const bar=c.querySelector('.bar')
const progress=c.querySelector('.progress')
play.onclick=()=>{if(video.paused){video.play();play.textContent='‚ùö‚ùö'}else{video.pause();play.textContent='‚ñ∂'}}
video.ontimeupdate=()=>{bar.style.width=(video.currentTime/video.duration*100||0)+'%'}
progress.onclick=e=>{video.currentTime=video.duration*(e.offsetX/progress.clientWidth)}
video.onclick=()=>{if(video.paused){video.play();play.textContent='‚ùö‚ùö'}else{video.pause();play.textContent='‚ñ∂'}}
video.addEventListener('play',()=>{fetch('/api/view/'+v.id,{method:'POST'})})
const likeBtn=document.getElementById('like-'+v.id)
likeBtn.onclick=async()=>{
if(localStorage.getItem(likesKey))return
localStorage.setItem(likesKey,'1')
likeBtn.style.color='red'
await fetch('/api/like/'+v.id,{method:'POST'})
let count=parseInt(likeBtn.textContent.replace(/\D/g,''))||0
likeBtn.textContent='‚ù§Ô∏è '+(count+1)
}
})
}

function toggleFullscreen(videoId){
const origCard=[...document.querySelectorAll('.videoCard')].find(c=>c.querySelector(`#like-${videoId}`))
if(!origCard) return
const origVideo=origCard.querySelector('video')
const clone=origVideo.cloneNode(true)
clone.controls=false
clone.loop=false
clone.autoplay=true

fullscreenWrapper.innerHTML=''
const wrapper=document.createElement('div')
wrapper.className='fullscreen-player'
wrapper.appendChild(clone)

const controls=document.createElement('div')
controls.className='controls'
controls.innerHTML=`<div class="play">‚ùö‚ùö</div><div class="progress"><div class="bar"></div></div>`
wrapper.appendChild(controls)
fullscreenWrapper.appendChild(wrapper)
fullscreenWrapper.style.display='flex'

const playBtn=controls.querySelector('.play')
const bar=controls.querySelector('.bar')
const progress=controls.querySelector('.progress')

playBtn.onclick=()=>{if(clone.paused){clone.play();playBtn.textContent='‚ùö‚ùö'}else{clone.pause();playBtn.textContent='‚ñ∂'}}
clone.ontimeupdate=()=>{bar.style.width=(clone.currentTime/clone.duration*100||0)+'%'}
progress.onclick=e=>{clone.currentTime=clone.duration*(e.offsetX/progress.clientWidth)}

wrapper.addEventListener('click', e=>{
if(e.target===wrapper) closeFullscreen()
})

document.addEventListener('keydown', e=>{if(e.key==='Escape') closeFullscreen()},{once:true})
}

function closeFullscreen(){
fullscreenWrapper.style.display='none'
fullscreenWrapper.innerHTML=''
}

function share(id){
const url=location.origin+'/video/'+id
if(navigator.share){
navigator.share({url})
}else{
navigator.clipboard.writeText(url)
alert('Link copiato')
}
}

async function comment(id, btn){
const i=document.getElementById('i-'+id)
const t=i.value.trim()
if(!t) return
btn.disabled=true
const r=await fetch('/api/comment/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})})
btn.disabled=false
const d=await r.json()
if(d.ok){
const comEl=document.getElementById('com-'+id)
const newComment=document.createElement('div')
newComment.className='comment'
newComment.textContent=d.comment.text
comEl.appendChild(newComment)
i.value=''
comEl.scrollTop=comEl.scrollHeight
}
}

document.addEventListener('touchstart', e=>startY=e.touches[0].clientY)
document.addEventListener('touchend', e=>{
const endY=e.changedTouches[0].clientY
if(startY-endY>80) window.scrollBy({top:window.innerHeight,behavior:'smooth'})
if(endY-startY>80) window.scrollBy({top:-window.innerHeight,behavior:'smooth'})
})

loadVideos()
</script>
</body>
</html>
